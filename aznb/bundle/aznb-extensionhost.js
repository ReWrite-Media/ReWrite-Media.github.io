(window.webpackJsonpAzureNotebooks=window.webpackJsonpAzureNotebooks||[]).push([[9],{"./src/features/extensionHost/async/index.ts":function(e,t,n){"use strict";n.r(t),n.d(t,"extensionHostCodeCellCommands",(function(){return Ye})),n.d(t,"extensionHostMarkdownCellCommands",(function(){return Ze})),n.d(t,"getExtensionOrder",(function(){return Je})),n.d(t,"ContextualKeys",(function(){return Ie})),n.d(t,"getIFrameHostClient",(function(){return Qe})),n.d(t,"getComputeHostClient",(function(){return et})),n.d(t,"getAznbServiceHostClient",(function(){return tt})),n.d(t,"getUiExtensionsClient",(function(){return nt})),n.d(t,"getExtensionHostClient",(function(){return st})),n.d(t,"getContextCreator",(function(){return it})),n.d(t,"onDispose",(function(){return rt})),n.d(t,"onLoad",(function(){return ot}));var s={};n.r(s),n.d(s,"isFalsyOrWhitespace",(function(){return ee})),n.d(s,"ContextKeyExprType",(function(){return se})),n.d(s,"ContextKeyExpr",(function(){return ie})),n.d(s,"ContextKeyFalseExpr",(function(){return oe})),n.d(s,"ContextKeyTrueExpr",(function(){return ae})),n.d(s,"ContextKeyDefinedExpr",(function(){return le})),n.d(s,"ContextKeyEqualsExpr",(function(){return ce})),n.d(s,"ContextKeyInExpr",(function(){return ue})),n.d(s,"ContextKeyNotInExpr",(function(){return de})),n.d(s,"ContextKeyNotEqualsExpr",(function(){return pe})),n.d(s,"ContextKeyNotExpr",(function(){return he})),n.d(s,"ContextKeyGreaterExpr",(function(){return ve})),n.d(s,"ContextKeyGreaterEqualsExpr",(function(){return ye})),n.d(s,"ContextKeySmallerExpr",(function(){return fe})),n.d(s,"ContextKeySmallerEqualsExpr",(function(){return me})),n.d(s,"ContextKeyRegexExpr",(function(){return be})),n.d(s,"ContextKeyNotRegexExpr",(function(){return ge})),n.d(s,"ContextKeyAndExpr",(function(){return xe})),n.d(s,"ContextKeyOrExpr",(function(){return Ce})),n.d(s,"RawContextKey",(function(){return Oe})),n.d(s,"SET_CONTEXT_COMMAND_ID",(function(){return ke}));var i=n("./node_modules/tslib/tslib.es6.js"),r=n("./src/features/monaco/index.ts"),o=n("./node_modules/redux-observable/dist/esm/operators.js"),a=n("./node_modules/rxjs/operators/index.js"),l=n("./src/common/actionHelper.ts"),c=n("./src/features/extensionHost/featureConstants.ts");const u=Object(l.a)(c.a+"__internal"),d=(u.create("extensionHostInitializedCommand"),u.create("addLoadedExtensions")),p=u.create("registerCellToolbarCommand"),h=u.create("cellTextEdits"),v=u.create("notebookEdits"),y=u.create("setDecorations"),f=u.create("refresh");u.create("executeCells");var m=n("./src/features/extensionHost/actions.ts"),b=n("./node_modules/typesafe-actions/dist/index.umd.js"),g=n("./node_modules/rxjs/index.js"),x=n("./src/core/notebook/selectors.ts"),C=n("../extension-protocols/dist/index.js"),O=n("./src/core/notebook/index.ts"),k=n("./node_modules/immutable/dist/immutable.es.js"),E=n("./node_modules/@nteract/commutable/lib/index.js"),j=n("./src/core/config/index.ts"),w=n("./src/events/actions.ts"),N=n("./src/events/types.ts"),I=n("./src/core/compute/index.ts"),T=n("./src/shell/actions.ts"),R=n("./src/services/globalServices.ts"),S=n("../extension-host/lib/index.js"),M=n("./node_modules/reconnecting-websocket/dist/reconnecting-websocket-mjs.js"),A=n("./node_modules/normalize-url/index.js"),_=n.n(A),z=n("./node_modules/url/url.js");function P(e,t){var n;return Object(i.b)(this,void 0,void 0,(function*(){return t===S.ExtensionHostKind.ServerCompute?Object(x.jupyterHostToken)(e):t===S.ExtensionHostKind.ServerAzureNotebooksService?yield null===(n=Object(R.a)())||void 0===n?void 0:n.tokenStore.getToken():void 0}))}var q=n("./node_modules/@nteract/core/lib/index.js"),D=n("./src/core/notebook/utils.ts");function K(e){return(t,n=g.EMPTY)=>(e(t),n)}function H(e,t){let n,s;return"number"==typeof t?(n=e.get(t),s=t):(n=t,s=e.indexOf(t),-1===s&&(s=void 0)),{id:n,idx:s}}var L=[(e,t)=>e.pipe(Object(a.filter)(Object(b.isActionOf)(m.b)),Object(a.withLatestFrom)(t),Object(a.switchMap)(([e,t])=>{const{kind:n,commandName:s,commandArgs:i}=e.payload,r=Object(x.activeContentRef)(t);let o;return n===S.ExtensionHostKind.BrowserIFrame?o=Qe(r):n===S.ExtensionHostKind.ServerAzureNotebooksService?o=tt(r):n===S.ExtensionHostKind.ServerCompute&&(o=et(r)),o?(o.sendCommand(s,i),g.EMPTY):(console.warn("tried sending command but client was undefined - is there an issue with feature flagging?"),g.EMPTY)})),(e,t)=>e.pipe(Object(a.filter)(Object(b.isActionOf)(m.a)),Object(a.withLatestFrom)(t),Object(a.switchMap)(([e,t])=>{var n,s,i;const{eventName:r,payload:o}=e.payload,a=Object(x.activeContentRef)(t);return null===(n=Qe(a))||void 0===n||n.sendEvent(r,o),null===(s=et(a))||void 0===s||s.sendEvent(r,o),null===(i=tt(a))||void 0===i||i.sendEvent(r,o),g.EMPTY})),(e,t,n)=>e.pipe(Object(o.a)(q.actions.SET_APP_HOST,Object(b.getType)(I.b.setComputeAsConnected),Object(b.getType)(T.a.setComputeCompleted),Object(b.getType)(I.b.changeKernel),Object(b.getType)(O.a.bearerTokenRenewed)),Object(a.debounceTime)(50),Object(a.withLatestFrom)(t),Object(a.switchMap)(([e,t])=>(function(e){Object(i.b)(this,void 0,void 0,(function*(){const t=j.d.getComputeExtensionHostOptions(e);if(null==t?void 0:t.enable){const n=Object(x.jupyterHostOrigin)(e),s=yield P(e,S.ExtensionHostKind.ServerCompute);if(!n||!s)throw new Error("Could not initialize compute extension host client");const i=function(e,t){let n="";if(e)try{const s=new URL(e);n=`${s.protocol}//${s.hostname}`,t&&(n=`${n}:${t}`)}catch(e){n=""}return n}(n,t.port),r=et(Object(x.activeContentRef)(e));if(!r)throw new Error("Could not fetch compute extension host client");yield r.initialize(i,s)}}))}(t),g.EMPTY))),(e,t,n)=>e.pipe(Object(a.filter)(e=>Object(b.isActionOf)(w.a.sendEvent)(e)&&e.meta.name===N.a.saveNotebook),Object(a.withLatestFrom)(t),Object(a.switchMap)(([e,t])=>{let n;return e.meta.name===N.a.runCell&&(n=C.Events.onDidSaveNotebookDocument),n?Object(g.of)(m.a({eventName:n,payload:{type:C.EventPayloadTypes.None,e:void 0}})):g.EMPTY})),(e,t,n)=>e.pipe(Object(a.filter)(Object(b.isActionOf)(j.a.setLocale)),Object(a.switchMap)(({payload:e})=>Object(g.of)(m.a({eventName:C.Events.onLocaleChange,payload:{type:C.EventPayloadTypes.Locale,e:{locale:e}}})))),(e,t,n)=>e.pipe(Object(a.filter)(e=>Object(b.isActionOf)(w.a.sendEvent)(e)&&[N.a.runCell].includes(e.meta.name)||Object(b.isActionOf)(O.a.setCellMetadata)(e)||Object(b.isActionOf)(O.a.clearOutputs)(e)||e.type===q.actions.CLEAR_OUTPUTS||Object(b.isActionOf)(O.a.clearAllOutputs)(e)||e.type===q.actions.CLEAR_ALL_OUTPUTS||e.type===q.actions.APPEND_OUTPUT),Object(a.withLatestFrom)(t),Object(a.switchMap)(([e,t])=>{const n=[];if(Object(b.isActionOf)(w.a.sendEvent)(e))e.meta.name===N.a.runCell&&n.push({cellId:e.meta.param,name:C.Events.onDidExecuteCell});else if(Object(b.isActionOf)(O.a.setCellMetadata)(e))n.push({cellId:e.payload.cellId,name:C.Events.onDidChangeCellMetadata});else if(Object(b.isActionOf)(O.a.clearOutputs)(e))n.push({cellId:e.payload.id,name:C.Events.onDidChangeCellOutputs});else if(e.type===q.actions.CLEAR_OUTPUTS){let s=e.payload.id;if(s||(s=Object(D.e)(t,e.payload.contentRef)),!s)return g.EMPTY;n.push({cellId:s,name:C.Events.onDidChangeCellOutputs})}else if(Object(b.isActionOf)(O.a.clearAllOutputs)(e)){const s=Object(x.getCellOrder)(t,{contentRef:e.payload.contentRef});n.push(...s.map(e=>({cellId:e,name:C.Events.onDidChangeCellOutputs})))}else if(e.type===q.actions.CLEAR_ALL_OUTPUTS){const s=Object(x.getCellOrder)(t,{contentRef:e.payload.contentRef});n.push(...s.map(e=>({cellId:e,name:C.Events.onDidChangeCellOutputs})))}else e.type===q.actions.APPEND_OUTPUT&&n.push({cellId:e.payload.id,name:C.Events.onDidChangeCellOutputs});const s=Object(x.activeContentRef)(t),i=n.map(({cellId:e,name:t})=>{var n;const i=null===(n=it(s))||void 0===n?void 0:n.getNotebookCellPayload(e);if(i&&t)return m.a({eventName:t,payload:{type:C.EventPayloadTypes.Cell,e:{cell:i}}})}).filter(e=>e);return Object(g.of)(...i)})),(e,t,n)=>e.pipe(Object(a.filter)(e=>Object(b.isActionOf)(w.a.sendEvent)(e)&&[N.a.changeKernel].includes(e.meta.name)),Object(a.withLatestFrom)(t),Object(a.switchMap)(([e,t])=>{var n;const s=null===(n=it(Object(x.activeContentRef)(t)))||void 0===n?void 0:n.getNotebookKernelPayload();if(!s)return g.EMPTY;let i;return e.meta.name===N.a.changeKernel&&(i=C.Events.onDidChangeActiveNotebookKernel),i?Object(g.of)(m.a({eventName:i,payload:{type:C.EventPayloadTypes.Kernel,e:{kernel:s}}})):g.EMPTY})),(e,t,n)=>e.pipe(Object(a.filter)(e=>Object(b.isActionOf)(w.a.sendEvent)(e)&&[N.a.cutCell,N.a.deleteCell,N.a.insertCell,N.a.pasteCell].includes(e.meta.name)),Object(a.withLatestFrom)(t),Object(a.switchMap)(([e,t])=>{var n;const s=C.Events.onDidChangeNotebookCells,i=[];if(e.meta.name===N.a.cutCell||e.meta.name===N.a.deleteCell){const t=e.meta.param;i.push({addedCells:[],deletedCellIds:[t]})}else if(e.meta.name===N.a.insertCell||e.meta.name===N.a.pasteCell){const s=e.meta.param,r=null===(n=it(Object(x.activeContentRef)(t)))||void 0===n?void 0:n.getNotebookCellPayload(s);if(!r)return g.EMPTY;i.push({addedCells:[r],deletedCellIds:[]})}return Object(g.of)(m.a({eventName:s,payload:{type:C.EventPayloadTypes.NotebookCells,e:{changes:i}}}))})),(e,t,n)=>e.pipe(Object(a.filter)(Object(b.isActionOf)(O.a.setCellLanguage)),Object(a.withLatestFrom)(t),Object(a.switchMap)(([e,t])=>{var n;const s=null===(n=it(e.payload.contentRef))||void 0===n?void 0:n.getNotebookCellPayload(e.payload.id);return s?Object(g.of)(m.a({eventName:C.Events.onDidChangeCellLanguage,payload:{type:C.EventPayloadTypes.CellLanguage,e:{cell:s,language:e.payload.languageId||""}}})):g.EMPTY})),(e,t)=>e.pipe(Object(a.filter)(Object(b.isActionOf)(y)),Object(a.withLatestFrom)(t),Object(a.switchMap)(([e,t])=>{const{cellId:n,edits:s,callback:i}=e.payload,o=K(i);for(const e of s){const{range:s,options:i}=e,o=Object(x.activeContentRef)(t),a=r.c.GlobalEditorManager.getEditor(r.a.Code,o,n);null==a||a.deltaDecorations([],[{range:s,options:i}])}return o(!1)})),(e,t)=>e.pipe(Object(a.filter)(Object(b.isActionOf)(h)),Object(a.withLatestFrom)(t),Object(a.switchMap)(([e,t])=>{var n;const{cellId:s,edits:i,clientVersion:o,callback:a}=e.payload,l=K(a),c=Object(x.activeContentRef)(t),u=null===(n=it(c))||void 0===n?void 0:n.getClientVersionComparator();if(!u||!u.checkCellSource(o,s))return l(!1);const d=r.c.GlobalEditorManager.getEditor(r.a.Code,c,s),p=null==d?void 0:d.getModel();return window.model=p,window.editor=d,p?(p.pushEditOperations([],i.map(e=>({text:e.text,range:{startLineNumber:e.range.startLineNumber+1,startColumn:e.range.startColumn+1,endLineNumber:e.range.endLineNumber+1,endColumn:e.range.endColumn+1}})),()=>null),l(!0)):l(!1)})),(e,t)=>e.pipe(Object(a.filter)(Object(b.isActionOf)(v)),Object(a.withLatestFrom)(t),Object(a.switchMap)(([e,t])=>{var n;const{edits:s,clientVersion:i,callback:r}=e.payload,o=K(r),a=Object(x.activeContentRef)(t),l=null===(n=it(a))||void 0===n?void 0:n.getClientVersionComparator();if(!l)return o(!1);const c=Object(x.getCellOrder)(t,{contentRef:a}),u=[],d={Replace:e=>{const{id:t,idx:n}=H(c,e.idOrIndex);if(!t||!n)return!1;for(let t=0;t<e.count;t++)if(n+t<c.count()){const e=c.get(n+t);if(!l.checkCell(i,e))return!1;u.push(q.actions.deleteCell({contentRef:a,id:e}))}for(const n of e.cells.slice().reverse())u.push(q.actions.createCellBelow({id:t,contentRef:a,cellType:n.cellKind,cell:Object(E.createCodeCell)({source:n.source,metadata:Object(k.Map)(n.metadata),outputs:Object(k.List)(n.outputs)})}));return!0},Insert:e=>{const{id:t,idx:n}=H(c,e.idOrIndex);if(!t||!n)return!1;const s=e.cellToInsert;return e.above?u.push(q.actions.createCellAbove({id:t,contentRef:a,cellType:s.cellKind,cell:Object(E.createCodeCell)({source:s.source,metadata:Object(k.Map)(s.metadata),outputs:Object(k.List)(s.outputs)})})):u.push(q.actions.createCellBelow({id:t,contentRef:a,cellType:s.cellKind,cell:Object(E.createCodeCell)({source:s.source,metadata:Object(k.Map)(s.metadata),outputs:Object(k.List)(s.outputs)})})),!0},Copy:e=>{const{id:t,idx:n}=H(c,e.idOrIndex);return!(!t||!n||(u.push(q.actions.copyCell({id:t,contentRef:a})),0))},Cut:e=>{const{id:t,idx:n}=H(c,e.idOrIndex);return!(!t||!n||!l.checkCell(i,t)||(u.push(q.actions.cutCell({id:t,contentRef:a})),0))},Paste:e=>{const{id:t,idx:n}=H(c,e.idOrIndex);return!(!t||!n||(u.push(q.actions.focusCell({id:t,contentRef:a})),e.above?u.push(O.a.pasteAbove({contentRef:a})):u.push(q.actions.pasteCell({contentRef:a})),0))},Output:e=>{const{id:t,idx:n}=H(c,e.idOrIndex);if(!t||!n)return!1;if(!l.checkCellOutputs(i,t))return!1;u.push(q.actions.clearOutputs({id:t,contentRef:a}));for(const n of e.outputs)u.push(q.actions.appendOutput({id:t,contentRef:a,output:n}));return!0},Metadata:e=>{const{id:t,idx:n}=H(c,e.idOrIndex);if(!t||!n)return!1;for(const n of Object.keys(e.metadata)){if(!l.checkCellMetadata(i,t,n))return!1;u.push(O.a.setCellMetadata({contentRef:a,cellId:t,key:n,value:e.metadata[n]}))}return!0},CellLanguage:e=>{const{id:t,idx:n}=H(c,e.idOrIndex);return!(!t||!n||!l.checkCellLanguage(i,t)||(u.push(O.a.setCellLanguage({id:t,contentRef:a,languageId:e.language})),0))},DocumentMetadata:e=>{for(const t of Object.keys(e.metadata)){if(!l.checkNotebookMetadata(i,t))return!1;u.push(O.a.setNotebookMetadata({contentRef:a,path:t,value:e.metadata[t]}))}return!0},OutputsSplice:e=>{const{id:n,idx:s}=H(c,e.idOrIndex);if(!n||!s)return!1;const r=function(e,t,n){const s=function(e,t){const n=q.selectors.model(e,{contentRef:t});return n&&"notebook"===n.type?n:null}(e,t);return s?q.selectors.notebook.cellById(s,{id:n}):void 0}(t,a,n);if(!r)return!1;let o=[];if("code"===r.cell_type&&(o=r.outputs.toJS()),e.splices.reverse().forEach(e=>{o.splice(e[0],e[1],...e[2])}),!l.checkCellOutputs(i,n))return!1;u.push(q.actions.clearOutputs({id:n,contentRef:a}));for(const e of o)u.push(q.actions.appendOutput({id:n,contentRef:a,output:e}));return!0},Move:e=>{const{id:t,idx:n}=H(c,e.idOrIndex);if(!t||!n)return!1;let s;if("string"==typeof e.idOrIndex&&"number"==typeof e.targetIdOrIndexOrOffset){const t=e.targetIdOrIndexOrOffset;s=c.get(n+t)}else{const{id:t,idx:n}=H(c,e.targetIdOrIndexOrOffset);if(!t||!n)return!1;s=t}return!(!s||!l.checkCellIndex(i,t)||(u.push(q.actions.moveCell({id:t,contentRef:a,destinationId:s,above:e.above||!1})),0))},Delete:e=>{const{id:t,idx:n}=H(c,e.idOrIndex);return!(!t||!n||!l.checkCell(i,t)||(u.push(q.actions.deleteCell({id:t,contentRef:a})),0))},Unknown:e=>!1};for(const e of s){const t=d[e.editType];if(t&&!t(e))return o(!1)}return o(!0,Object(g.of)(...u))})),(e,t)=>e.pipe(Object(a.filter)(Object(b.isActionOf)(f)),Object(a.withLatestFrom)(t),Object(a.switchMap)(([e,t])=>{const{refreshType:n,cellId:s,callback:i}=e.payload,r=K(i),o=it(Object(x.activeContentRef)(t));if(!o)return r(!1);if(n===C.RefreshTypes.ExtensionContext)return r(o.getExtensionContextPayload());if(n===C.RefreshTypes.NotebookContext)return r(o.getNotebookContextPayload());if(n===C.RefreshTypes.NotebookEditor)return r(o.getNotebookEditorPayload());if(n===C.RefreshTypes.NotebookDocument)return r(o.getNotebookDocumentPayload());if(n===C.RefreshTypes.NotebookKernel)return r(o.getNotebookKernelPayload());if(!s)return r(!1);let a;return n===C.RefreshTypes.NotebookCell?a=o.getNotebookCellPayload(s):n===C.RefreshTypes.CellTextDocument?a=o.getCellTextDocumentPayload(s):n===C.RefreshTypes.CellTextEditor&&(a=o.getCellTextEditorPayload(s)),r(a||!1)}))],F=n("./node_modules/crypto-browserify/index.js");class V{constructor(e,t){this.notebook=e,this.cells=t}checkNotebook(e){var t,n;return(null===(t=this.notebook)||void 0===t?void 0:t.version)===(null===(n=e.notebook)||void 0===n?void 0:n.version)}checkNotebookMetadata(e,t){var n,s,i,r;return t?(null===(n=this.notebook)||void 0===n?void 0:n.properties.metadata.properties[t])===(null===(s=e.notebook)||void 0===s?void 0:s.properties.metadata.properties[t]):(null===(i=this.notebook)||void 0===i?void 0:i.properties.metadata.version)===(null===(r=e.notebook)||void 0===r?void 0:r.properties.metadata.version)}checkCell(e,t){var n,s;return(null===(n=this.cells)||void 0===n?void 0:n[t].version)===(null===(s=e.cells)||void 0===s?void 0:s[t].version)}checkCellIndex(e,t){var n,s;return(null===(n=this.cells)||void 0===n?void 0:n[t].properties.index)===(null===(s=e.cells)||void 0===s?void 0:s[t].properties.index)}checkCellKind(e,t){var n,s;return(null===(n=this.cells)||void 0===n?void 0:n[t].properties.cellKind)===(null===(s=e.cells)||void 0===s?void 0:s[t].properties.cellKind)}checkCellExecutionCount(e,t){var n,s;return(null===(n=this.cells)||void 0===n?void 0:n[t].properties.executionCount)===(null===(s=e.cells)||void 0===s?void 0:s[t].properties.executionCount)}checkCellLanguage(e,t){var n,s;return(null===(n=this.cells)||void 0===n?void 0:n[t].properties.language)===(null===(s=e.cells)||void 0===s?void 0:s[t].properties.language)}checkCellSource(e,t){var n,s;return(null===(n=this.cells)||void 0===n?void 0:n[t].properties.source)===(null===(s=e.cells)||void 0===s?void 0:s[t].properties.source)}checkCellOutputs(e,t){var n,s;return(null===(n=this.cells)||void 0===n?void 0:n[t].properties.outputs)===(null===(s=e.cells)||void 0===s?void 0:s[t].properties.outputs)}checkCellMetadata(e,t,n){var s,i,r,o,a;return n?(null===(s=this.cells)||void 0===s?void 0:s[t].properties.metadata.properties[n])===(null===(r=null===(i=e.cells)||void 0===i?void 0:i[t])||void 0===r?void 0:r.properties.metadata.properties[n]):(null===(o=this.cells)||void 0===o?void 0:o[t].properties.metadata.version)===(null===(a=e.cells)||void 0===a?void 0:a[t].properties.metadata.version)}}function $(e,t){const n=q.selectors.model(e,{contentRef:t});return n&&"notebook"===n.type?n:null}function U(e,t,n){const s=$(e,t);return s?q.selectors.notebook.cellById(s,{id:n}):void 0}function B(e){return F.createHash("md5").update(JSON.stringify(null!=e?e:"")).digest("hex")}class G{constructor(e){this.store=e}getExtensionContextPayload(){return{notebook:this.getNotebookContextPayload()}}getNotebookContextPayload(){const e=this.store.getState(),t=Object(x.getFocusedCell)(e);return{editor:this.getNotebookEditorPayload(),activeCellTextEditor:t?this.getCellTextEditorPayload(t):void 0}}getNotebookEditorPayload(){const e=this.store.getState(),t=Object(x.getFocusedCell)(e);return{document:this.getNotebookDocumentPayload(),focusedCell:t?this.getNotebookCellPayload(t):void 0,kernel:this.getNotebookKernelPayload()}}getNotebookCellPayload(e,t){const n=this.store.getState(),s=Object(x.activeContentRef)(n),i=U(n,s,e),r=this.getCellTextEditorPayload(e);if(void 0===i||void 0===r)return;const o=i.get("execution_count",null);void 0===t&&(t=Object(x.getCellOrder)(n,{contentRef:s}).toJS().indexOf(e));const a=Object(x.getCellLanguage)(n,s,e);let l=[];return"code"===i.cell_type&&(l=i.outputs.toJS()),{id:e,index:t,cellKind:i.cell_type,executionCount:o,language:a,editor:r,outputs:l,metadata:i.metadata.toJS()}}getCellTextDocumentPayload(e){var t,n;const s=this.store.getState(),i=Object(x.activeContentRef)(s),o=Object(x.getCellLanguage)(s,i,e),a=r.c.GlobalEditorManager.getEditor(r.a.Code,i,e);return{languageId:o,lines:(null===(t=null==a?void 0:a.getModel())||void 0===t?void 0:t.getLinesContent())||[],eol:(null===(n=null==a?void 0:a.getModel())||void 0===n?void 0:n.getEOL())||"\n"}}getCellTextEditorPayload(e){const t=this.store.getState(),n=Object(x.activeContentRef)(t),s=U(t,n,e),i=this.getCellTextDocumentPayload(e);if(void 0===s||void 0===i)return;const o=r.c.GlobalEditorManager.getEditor(r.a.Code,n,e),a=null==o?void 0:o.getSelection();return{document:i,selection:{startLineNumber:(null==a?void 0:a.startLineNumber)?(null==a?void 0:a.startLineNumber)-1:0,startColumn:(null==a?void 0:a.startColumn)?(null==a?void 0:a.startColumn)-1:0,endLineNumber:(null==a?void 0:a.endLineNumber)?(null==a?void 0:a.endLineNumber)-1:0,endColumn:(null==a?void 0:a.endColumn)?(null==a?void 0:a.endColumn)-1:0}}}getNotebookDocumentPayload(){const e=this.store.getState(),t=Object(x.activeContentRef)(e),n=Object(x.getCellOrder)(e,{contentRef:t}).toJS(),s=$(e,t),i=Object(D.d)(e,{contentRef:t});return{version:Object(x.fileVersion)(e)||"",instanceId:t,jsonString:i?Object(D.i)(i.content):"",filePath:Object(x.getFilePath)(e),isDirty:Object(D.g)(e,t)||!1,cells:n.map(e=>this.getNotebookCellPayload(e)).filter(e=>e),metadata:s?q.selectors.notebook.metadata(s):s}}getNotebookKernelPayload(){const e=this.store.getState(),t=q.selectors.currentKernelRef(e)||"",n=Object(x.getKernelEventPayload)(e,t);return{id:n.kernelId,label:n.kernelName||"",isPreferred:!0}}getNotebookVersion(){const e=this.getNotebookDocumentPayload(),t={};for(const n of Object.keys(e.metadata||{}))t[n]=B(e.metadata[n]);return{version:B(e),properties:{metadata:{version:B(e.metadata),properties:t}}}}getCellVersion(e){const t=this.getNotebookCellPayload(e);if(!t)throw new Error("Shouldn't have an empty payload if we have a valid cell ID");const n={};for(const e of Object.keys(t.metadata||{}))n[e]=B(t.metadata[e]);return{version:B(t),properties:{index:B(t.index),cellKind:B(t.cellKind),executionCount:B(t.executionCount),language:B(t.language),source:B(t.editor.document.lines),outputs:B(t.outputs),metadata:{version:B(t.metadata),properties:n}}}}getClientVersion(){const e=this.store.getState(),t=Object(x.activeContentRef)(e),n=Object(x.getCellOrder)(e,{contentRef:t}).toJS(),s={};for(const e of n)s[e]=this.getCellVersion(e);return{notebook:this.getNotebookVersion(),cells:s}}getClientVersionComparator(){const e=this.getClientVersion();return new V(e.notebook,e.cells)}}const J={codeCellCommands:[],markdownCellCommands:[],extensionOrder:[]};function Y(e=J,t){switch(t.type){case Object(b.getType)(d):const n=t.payload;return Object.assign(Object.assign({},e),{extensionOrder:e.extensionOrder.concat(n)});case Object(b.getType)(p):const{kind:s,key:i,type:r,commandName:o,commandDisplayName:a,commandDisabledDisplayMessage:l,ariaLabel:c,iconName:u,isDisabled:h,extensionId:v,executeCommand:y}=t.payload;return"code"===r?Object.assign(Object.assign({},e),{codeCellCommands:e.codeCellCommands.concat([{key:i,extension:{extensionId:v,kind:s,commandName:o,commandDisplayName:a,commandDisabledDisplayMessage:l,ariaLabel:c,iconName:u,isDisabled:h,executeCommand:y}}])}):Object.assign(Object.assign({},e),{markdownCellCommands:e.markdownCellCommands.concat([{key:i,extension:{extensionId:v,displayInEdit:"markdown-edit"===r||"markdown"===r,displayInPreview:"markdown-preview"===r||"markdown"===r,kind:s,commandName:o,commandDisplayName:a,commandDisabledDisplayMessage:l,ariaLabel:c,iconName:u,isDisabled:h,executeCommand:y}}])});default:return e}}const Z={"Content-Type":"application/json"};class W extends C.ClientRpcClient{constructor(e,t){var n;super(C.CommTypes.Stateless),this.contextCreator=e,this.hostUrl=t;const s=null===(n=Object(R.a)())||void 0===n?void 0:n.azureNotebookServicesRequest;if(!s)throw new Error("Global services are not initialized correctly. Please check the AzureNotebookComponent initialization code.");this.request=s}callImpl(e,t,n,s){return Object(i.b)(this,void 0,void 0,(function*(){const r=this.hostUrl,o=this.composeMessage(e,C.MessageType.Request,t,n),a=()=>Object(i.b)(this,void 0,void 0,(function*(){const t=yield this.request.post(r,o,Z);if(t.header.messageType!==C.MessageType.Response||t.header.op!==e)throw new Error("Received invalid response");return t}));return s?new Promise((e,t)=>{setTimeout(()=>{t("Request timed out")},s),a().then(t=>{e(t)})}):yield a()}))}sendImpl(e){const t=this.hostUrl;this.request.post(t,e,Z)}overrideHeaders(e,t){return e===C.ClientToServerOps.Handshake?{}:{clientVersion:this.contextCreator.getClientVersion()}}validateMessage(e){return!!S.MessageValidator.validateSchema(e)}}var X=n("./node_modules/uuid/dist/esm-browser/v4.js");class Q extends C.ClientRpcClient{constructor(e,t,n){super(C.CommTypes.Stateful),this.contextCreator=e,this.socket=t,this.socket.onmessage=e=>{const t=JSON.parse(e.data);if(!(t.header&&t.header.op&&t.header.messageType&&t.header.schemaVersion))throw new Error("Received invalid message");t.header.requestId&&Q.resolveMessage(t.header.requestId,t)||n(t)}}static resolveMessage(e,t){const n=Q.outboundMessages[e];return!!n&&t.header.messageType===C.MessageType.Response&&t.header.op===n.op&&(n.resolve(t),!0)}callImpl(e,t,n,s){return Object(i.b)(this,void 0,void 0,(function*(){let i=Object(X.a)();for(;Q.outboundMessages[i];)i=Object(X.a)();const r=this.composeMessage(e,C.MessageType.Request,t,n);return r.header.requestId=i,this.socket.send(JSON.stringify(r)),new Promise((t,n)=>{Q.outboundMessages[i]={resolve:e=>{delete Q.outboundMessages[i],t(e)},op:e},s&&setTimeout(()=>{delete Q.outboundMessages[i],n(new Error("Request timed out"))},s)})}))}sendImpl(e){this.socket.send(JSON.stringify(e))}overrideHeaders(e,t){return{clientVersion:this.contextCreator.getClientVersion()}}validateMessage(e){return!!S.MessageValidator.validateSchema(e)}}function ee(e){return!e||"string"!=typeof e||0===e.trim().length}Q.outboundMessages={};const te=new Map;te.set("false",!1),te.set("true",!0);const ne=Object.prototype.hasOwnProperty;var se;!function(e){e[e.False=0]="False",e[e.True=1]="True",e[e.Defined=2]="Defined",e[e.Not=3]="Not",e[e.Equals=4]="Equals",e[e.NotEquals=5]="NotEquals",e[e.And=6]="And",e[e.Regex=7]="Regex",e[e.NotRegex=8]="NotRegex",e[e.Or=9]="Or",e[e.In=10]="In",e[e.NotIn=11]="NotIn",e[e.Greater=12]="Greater",e[e.GreaterEquals=13]="GreaterEquals",e[e.Smaller=14]="Smaller",e[e.SmallerEquals=15]="SmallerEquals"}(se||(se={}));class ie{static false(){return oe.INSTANCE}static true(){return ae.INSTANCE}static has(e){return le.create(e)}static equals(e,t){return ce.create(e,t)}static notEquals(e,t){return pe.create(e,t)}static regex(e,t){return be.create(e,t)}static in(e,t){return ue.create(e,t)}static not(e){return he.create(e)}static and(...e){return xe.create(e)}static or(...e){return Ce.create(e)}static greater(e,t){return ve.create(e,t)}static less(e,t){return fe.create(e,t)}static deserialize(e,t=!1){if(e)return this._deserializeOrExpression(e,t)}static _deserializeOrExpression(e,t){let n=e.split("||");return Ce.create(n.map(e=>this._deserializeAndExpression(e,t)))}static _deserializeAndExpression(e,t){let n=e.split("&&");return xe.create(n.map(e=>this._deserializeOne(e,t)))}static _deserializeOne(e,t){if((e=e.trim()).indexOf("!=")>=0){let n=e.split("!=");return pe.create(n[0].trim(),this._deserializeValue(n[1],t))}if(e.indexOf("==")>=0){let n=e.split("==");return ce.create(n[0].trim(),this._deserializeValue(n[1],t))}if(e.indexOf("=~")>=0){let n=e.split("=~");return be.create(n[0].trim(),this._deserializeRegexValue(n[1],t))}if(e.indexOf(" in ")>=0){let t=e.split(" in ");return ue.create(t[0].trim(),t[1].trim())}if(/^[^<=>]+>=[^<=>]+$/.test(e)){const t=e.split(">=");return ye.create(t[0].trim(),t[1].trim())}if(/^[^<=>]+>[^<=>]+$/.test(e)){const t=e.split(">");return ve.create(t[0].trim(),t[1].trim())}if(/^[^<=>]+<=[^<=>]+$/.test(e)){const t=e.split("<=");return me.create(t[0].trim(),t[1].trim())}if(/^[^<=>]+<[^<=>]+$/.test(e)){const t=e.split("<");return fe.create(t[0].trim(),t[1].trim())}return/^\!\s*/.test(e)?he.create(e.substr(1).trim()):le.create(e)}static _deserializeValue(e,t){if("true"===(e=e.trim()))return!0;if("false"===e)return!1;let n=/^'([^']*)'$/.exec(e);return n?n[1].trim():e}static _deserializeRegexValue(e,t){if(ee(e)){if(t)throw new Error("missing regexp-value for =~-expression");return console.warn("missing regexp-value for =~-expression"),null}let n=e.indexOf("/"),s=e.lastIndexOf("/");if(n===s||n<0){if(t)throw new Error(`bad regexp-value '${e}', missing /-enclosure`);return console.warn(`bad regexp-value '${e}', missing /-enclosure`),null}let i=e.slice(n+1,s),r="i"===e[s+1]?"i":"";try{return new RegExp(i,r)}catch(n){if(t)throw new Error(`bad regexp-value '${e}', parse error: ${n}`);return console.warn(`bad regexp-value '${e}', parse error: ${n}`),null}}}function re(e,t){return e.cmp(t)}class oe{constructor(){this.type=se.False}cmp(e){return this.type-e.type}equals(e){return e.type===this.type}evaluate(e){return!1}serialize(){return"false"}keys(){return[]}map(e){return this}negate(){return ae.INSTANCE}}oe.INSTANCE=new oe;class ae{constructor(){this.type=se.True}cmp(e){return this.type-e.type}equals(e){return e.type===this.type}evaluate(e){return!0}serialize(){return"true"}keys(){return[]}map(e){return this}negate(){return oe.INSTANCE}}ae.INSTANCE=new ae;class le{constructor(e){this.key=e,this.type=se.Defined}static create(e){const t=te.get(e);return"boolean"==typeof t?t?ae.INSTANCE:oe.INSTANCE:new le(e)}cmp(e){return e.type!==this.type?this.type-e.type:Ee(this.key,e.key)}equals(e){return e.type===this.type&&this.key===e.key}evaluate(e){return!!e.getValue(this.key)}serialize(){return this.key}keys(){return[this.key]}map(e){return e.mapDefined(this.key)}negate(){return he.create(this.key)}}class ce{constructor(e,t){this.key=e,this.value=t,this.type=se.Equals}static create(e,t){if("boolean"==typeof t)return t?le.create(e):he.create(e);const n=te.get(e);return"boolean"==typeof n?t===(n?"true":"false")?ae.INSTANCE:oe.INSTANCE:new ce(e,t)}cmp(e){return e.type!==this.type?this.type-e.type:je(this.key,this.value,e.key,e.value)}equals(e){return e.type===this.type&&this.key===e.key&&this.value===e.value}evaluate(e){return e.getValue(this.key)==this.value}serialize(){return`${this.key} == '${this.value}'`}keys(){return[this.key]}map(e){return e.mapEquals(this.key,this.value)}negate(){return pe.create(this.key,this.value)}}class ue{constructor(e,t){this.key=e,this.valueKey=t,this.type=se.In}static create(e,t){return new ue(e,t)}cmp(e){return e.type!==this.type?this.type-e.type:je(this.key,this.valueKey,e.key,e.valueKey)}equals(e){return e.type===this.type&&this.key===e.key&&this.valueKey===e.valueKey}evaluate(e){const t=e.getValue(this.valueKey),n=e.getValue(this.key);return Array.isArray(t)?t.indexOf(n)>=0:"string"==typeof n&&"object"==typeof t&&null!==t&&ne.call(t,n)}serialize(){return`${this.key} in '${this.valueKey}'`}keys(){return[this.key,this.valueKey]}map(e){return e.mapIn(this.key,this.valueKey)}negate(){return de.create(this)}}class de{constructor(e){this._actual=e,this.type=se.NotIn}static create(e){return new de(e)}cmp(e){return e.type!==this.type?this.type-e.type:this._actual.cmp(e._actual)}equals(e){return e.type===this.type&&this._actual.equals(e._actual)}evaluate(e){return!this._actual.evaluate(e)}serialize(){throw new Error("Method not implemented.")}keys(){return this._actual.keys()}map(e){return new de(this._actual.map(e))}negate(){return this._actual}}class pe{constructor(e,t){this.key=e,this.value=t,this.type=se.NotEquals}static create(e,t){if("boolean"==typeof t)return t?he.create(e):le.create(e);const n=te.get(e);return"boolean"==typeof n?t===(n?"true":"false")?oe.INSTANCE:ae.INSTANCE:new pe(e,t)}cmp(e){return e.type!==this.type?this.type-e.type:je(this.key,this.value,e.key,e.value)}equals(e){return e.type===this.type&&this.key===e.key&&this.value===e.value}evaluate(e){return e.getValue(this.key)!=this.value}serialize(){return`${this.key} != '${this.value}'`}keys(){return[this.key]}map(e){return e.mapNotEquals(this.key,this.value)}negate(){return ce.create(this.key,this.value)}}class he{constructor(e){this.key=e,this.type=se.Not}static create(e){const t=te.get(e);return"boolean"==typeof t?t?oe.INSTANCE:ae.INSTANCE:new he(e)}cmp(e){return e.type!==this.type?this.type-e.type:Ee(this.key,e.key)}equals(e){return e.type===this.type&&this.key===e.key}evaluate(e){return!e.getValue(this.key)}serialize(){return"!"+this.key}keys(){return[this.key]}map(e){return e.mapNot(this.key)}negate(){return le.create(this.key)}}class ve{constructor(e,t){this.key=e,this.value=t,this.type=se.Greater}static create(e,t){return new ve(e,t)}cmp(e){return e.type!==this.type?this.type-e.type:je(this.key,this.value,e.key,e.value)}equals(e){return e.type===this.type&&this.key===e.key&&this.value===e.value}evaluate(e){return parseFloat(e.getValue(this.key))>parseFloat(this.value)}serialize(){return`${this.key} > ${this.value}`}keys(){return[this.key]}map(e){return e.mapGreater(this.key,this.value)}negate(){return me.create(this.key,this.value)}}class ye{constructor(e,t){this.key=e,this.value=t,this.type=se.GreaterEquals}static create(e,t){return new ye(e,t)}cmp(e){return e.type!==this.type?this.type-e.type:je(this.key,this.value,e.key,e.value)}equals(e){return e.type===this.type&&this.key===e.key&&this.value===e.value}evaluate(e){return parseFloat(e.getValue(this.key))>=parseFloat(this.value)}serialize(){return`${this.key} >= ${this.value}`}keys(){return[this.key]}map(e){return e.mapGreaterEquals(this.key,this.value)}negate(){return fe.create(this.key,this.value)}}class fe{constructor(e,t){this.key=e,this.value=t,this.type=se.Smaller}static create(e,t){return new fe(e,t)}cmp(e){return e.type!==this.type?this.type-e.type:je(this.key,this.value,e.key,e.value)}equals(e){return e.type===this.type&&this.key===e.key&&this.value===e.value}evaluate(e){return parseFloat(e.getValue(this.key))<parseFloat(this.value)}serialize(){return`${this.key} < ${this.value}`}keys(){return[this.key]}map(e){return e.mapSmaller(this.key,this.value)}negate(){return ye.create(this.key,this.value)}}class me{constructor(e,t){this.key=e,this.value=t,this.type=se.SmallerEquals}static create(e,t){return new me(e,t)}cmp(e){return e.type!==this.type?this.type-e.type:je(this.key,this.value,e.key,e.value)}equals(e){return e.type===this.type&&this.key===e.key&&this.value===e.value}evaluate(e){return parseFloat(e.getValue(this.key))<=parseFloat(this.value)}serialize(){return`${this.key} <= ${this.value}`}keys(){return[this.key]}map(e){return e.mapSmallerEquals(this.key,this.value)}negate(){return ve.create(this.key,this.value)}}class be{constructor(e,t){this.key=e,this.regexp=t,this.type=se.Regex}static create(e,t){return new be(e,t)}cmp(e){if(e.type!==this.type)return this.type-e.type;if(this.key<e.key)return-1;if(this.key>e.key)return 1;const t=this.regexp?this.regexp.source:"",n=e.regexp?e.regexp.source:"";return t<n?-1:t>n?1:0}equals(e){if(e.type===this.type){const t=this.regexp?this.regexp.source:"",n=e.regexp?e.regexp.source:"";return this.key===e.key&&t===n}return!1}evaluate(e){let t=e.getValue(this.key);return!!this.regexp&&this.regexp.test(t)}serialize(){const e=this.regexp?`/${this.regexp.source}/${this.regexp.ignoreCase?"i":""}`:"/invalid/";return`${this.key} =~ ${e}`}keys(){return[this.key]}map(e){return e.mapRegex(this.key,this.regexp)}negate(){return ge.create(this)}}class ge{constructor(e){this._actual=e,this.type=se.NotRegex}static create(e){return new ge(e)}cmp(e){return e.type!==this.type?this.type-e.type:this._actual.cmp(e._actual)}equals(e){return e.type===this.type&&this._actual.equals(e._actual)}evaluate(e){return!this._actual.evaluate(e)}serialize(){throw new Error("Method not implemented.")}keys(){return this._actual.keys()}map(e){return new ge(this._actual.map(e))}negate(){return this._actual}}class xe{constructor(e){this.expr=e,this.type=se.And}static create(e){return xe._normalizeArr(e)}cmp(e){if(e.type!==this.type)return this.type-e.type;if(this.expr.length<e.expr.length)return-1;if(this.expr.length>e.expr.length)return 1;for(let t=0,n=this.expr.length;t<n;t++){const n=re(this.expr[t],e.expr[t]);if(0!==n)return n}return 0}equals(e){if(e.type===this.type){if(this.expr.length!==e.expr.length)return!1;for(let t=0,n=this.expr.length;t<n;t++)if(!this.expr[t].equals(e.expr[t]))return!1;return!0}return!1}evaluate(e){for(let t=0,n=this.expr.length;t<n;t++)if(!this.expr[t].evaluate(e))return!1;return!0}static _normalizeArr(e){const t=[];let n=!1;for(const s of e)if(s)if(s.type!==se.True){if(s.type===se.False)return oe.INSTANCE;s.type!==se.And?t.push(s):t.push(...s.expr)}else n=!0;if(0===t.length&&n)return ae.INSTANCE;if(0!==t.length){if(1===t.length)return t[0];for(t.sort(re);t.length>1;){const e=t[t.length-1];if(e.type!==se.Or)break;t.pop();const n=t.pop(),s=Ce.create(e.expr.map(e=>xe.create([e,n])));s&&(t.push(s),t.sort(re))}return 1===t.length?t[0]:new xe(t)}}serialize(){return this.expr.map(e=>e.serialize()).join(" && ")}keys(){const e=[];for(let t of this.expr)e.push(...t.keys());return e}map(e){return new xe(this.expr.map(t=>t.map(e)))}negate(){let e=[];for(let t of this.expr)e.push(t.negate());return Ce.create(e)}}class Ce{constructor(e){this.expr=e,this.type=se.Or}static create(e){const t=Ce._normalizeArr(e);if(0!==t.length)return 1===t.length?t[0]:new Ce(t)}cmp(e){if(e.type!==this.type)return this.type-e.type;if(this.expr.length<e.expr.length)return-1;if(this.expr.length>e.expr.length)return 1;for(let t=0,n=this.expr.length;t<n;t++){const n=re(this.expr[t],e.expr[t]);if(0!==n)return n}return 0}equals(e){if(e.type===this.type){if(this.expr.length!==e.expr.length)return!1;for(let t=0,n=this.expr.length;t<n;t++)if(!this.expr[t].equals(e.expr[t]))return!1;return!0}return!1}evaluate(e){for(let t=0,n=this.expr.length;t<n;t++)if(this.expr[t].evaluate(e))return!0;return!1}static _normalizeArr(e){let t=[],n=!1;if(e){for(let s=0,i=e.length;s<i;s++){const i=e[s];if(i)if(i.type!==se.False){if(i.type===se.True)return[ae.INSTANCE];i.type!==se.Or?t.push(i):t=t.concat(i.expr)}else n=!0}if(0===t.length&&n)return[oe.INSTANCE];t.sort(re)}return t}serialize(){return this.expr.map(e=>e.serialize()).join(" || ")}keys(){const e=[];for(let t of this.expr)e.push(...t.keys());return e}map(e){return new Ce(this.expr.map(t=>t.map(e)))}negate(){let e=[];for(let t of this.expr)e.push(t.negate());const t=e=>e.type===se.Or?e.expr:[e];for(;e.length>1;){const n=e.shift(),s=e.shift(),i=[];for(const e of t(n))for(const n of t(s))i.push(ie.and(e,n));e.unshift(ie.or(...i))}return e[0]}}class Oe extends le{constructor(e,t,n){super(e),this.key=e,"object"==typeof n?Oe._info.push(Object.assign(Object.assign({},n),{key:e})):!0!==n&&Oe._info.push({key:e,description:n,type:null!=t?typeof t:void 0})}static all(){return Oe._info.values()}toNegated(){return ie.not(this.key)}isEqualTo(e){return ie.equals(this.key,e)}notEqualsTo(e){return ie.notEquals(this.key,e)}}Oe._info=[];const ke="setContext";function Ee(e,t){return e<t?-1:e>t?1:0}function je(e,t,n,s){return e<n?-1:e>n?1:t<s?-1:t>s?1:0}class we{constructor(e={}){this.env=e}getValue(e){return this.env[e]}update(e,t){this.env[e]=t}branch(e={}){return new we(Object.assign(Object.assign({},this.env),e))}}const Ne=new we,Ie=Object.assign(Object.assign({},s),{getGlobalEnv:()=>Ne});var Te=n("./src/common/localization/index.ts"),Re=n("./src/core/notebook/actions/index.ts"),Se=n("./node_modules/@uifabric/styling/lib/index.js");class Me{constructor(e){this.store=e}Message(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){}))}EditCell(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){if(!e.clientVersion)throw new Error("Expected non-empty client version");this.store.dispatch(h({cellId:t.params.cellId,edits:t.params.edits,clientVersion:e.clientVersion,callback:t=>{n.commType===C.CommTypes.Stateful&&n.respond(C.ServerToClientOps.Exec,{execAction:C.ExecActions.EditCell,params:t},{requestId:e.requestId})}}))}))}EditNotebook(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){if(!e.clientVersion)throw new Error("Expected non-empty client version");this.store.dispatch(v({edits:t.params.edits,clientVersion:e.clientVersion,callback:t=>{n.commType===C.CommTypes.Stateful&&n.respond(C.ServerToClientOps.Exec,{execAction:C.ExecActions.EditNotebook,params:t},{requestId:e.requestId})}}))}))}Refresh(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){if(n.commType!==C.CommTypes.Stateful)throw new Error("Only stateful refresh requests are allowed");this.store.dispatch(f({refreshType:t.params.type,cellId:t.params.cellId,callback:t=>{n.respond(C.ServerToClientOps.Exec,{execAction:C.ExecActions.Refresh,params:t},{requestId:e.requestId})}}))}))}SaveNotebook(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){const e=Object(x.activeContentRef)(this.store.getState());this.store.dispatch(Re.a.saveNotebook({contentRef:e}))}))}ExecuteCells(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){const e=Object(x.activeContentRef)(this.store.getState());if(this.store.dispatch(I.b.executeRunQueue()),!0===t.params.cellIds)this.store.dispatch(q.actions.executeAllCells({contentRef:e}));else for(const n of t.params.cellIds)this.store.dispatch(q.actions.executeCell({id:n,contentRef:e}))}))}InterruptKernel(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){const e=Object(x.activeContentRef)(this.store.getState());this.store.dispatch(Re.a.interruptKernel({kernelRef:void 0,contentRef:e}))}))}Error(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){console.error(t.params),n.commType===C.CommTypes.Stateful&&n.respond(C.ServerToClientOps.Exec,{execAction:C.ExecActions.Error,params:!0},{requestId:e.requestId})}))}SetDecorations(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){this.store.dispatch(y({cellId:t.params.cellId,edits:t.params.edits,callback:t=>{n.commType===C.CommTypes.Stateful&&n.respond(C.ServerToClientOps.Exec,{execAction:C.ExecActions.SetDecorations,params:t},{requestId:e.requestId})}}))}))}}class Ae{constructor(e,t,n){this.kind=e,this.store=t,this.execHandler=n}Exec(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){const s=this.execHandler[t.execAction];s&&(yield s.bind(this.execHandler)(e,t,n))}))}RegisterCellToolbarCommand(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){const{extensionId:e,commandName:s,type:i,commandDisplayName:r,commandDisabledDisplayMessage:o,ariaLabel:a,iconName:l,isDisabled:u}=t;this.store.dispatch(p({extensionId:e,kind:this.kind,key:`${c.a}/${this.kind}/${s}`,commandName:s,type:i,commandDisplayName:e=>{if("string"==typeof r)return r;const t=Te.a.getCurrentUILanguage();return r[t]||""},commandDisabledDisplayMessage:e=>{if("string"==typeof o)return o;const t=Te.a.getCurrentUILanguage();return o[t]||""},ariaLabel:e=>{if("string"==typeof a)return a;const t=Te.a.getCurrentUILanguage();return a[t]||""},iconName:e=>{var t;if(!l)return"";if("string"==typeof l)return l;for(const n of l)if(null===(t=Ie.ContextKeyExpr.deserialize(n.when))||void 0===t?void 0:t.evaluate(Ie.getGlobalEnv().branch(e)))return n.iconName;return""},isDisabled:e=>{var t;if(void 0===u)return!1;if("boolean"==typeof u)return u;const n=null===(t=Ie.ContextKeyExpr.deserialize(u.when))||void 0===t?void 0:t.evaluate(Ie.getGlobalEnv().branch(e));return null!=n&&n},executeCommand:e=>{this.store.dispatch(m.b({kind:this.kind,commandName:s,commandArgs:e}))}})),n.commType===C.CommTypes.Stateful&&n.respond(C.ServerToClientOps.RegisterCellToolbarCommand,!0)}))}SetContextKey(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){const{key:e,data:n}=t;Ie.getGlobalEnv().update(e,n)}))}ExtensionToUIMessage(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){const{extensionId:e,instanceId:n,cellId:s,message:i}=t,r=nt(Object(x.activeContentRef)(this.store.getState()));r&&r.postUIElementMessage({extensionId:e,instanceId:n,cellId:s,message:i})}))}CreateView(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){const n=nt(Object(x.activeContentRef)(this.store.getState()));n&&e.requestId&&n.createUIElement(t,e.requestId,this.kind)}))}UpdateView(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){const n=nt(Object(x.activeContentRef)(this.store.getState()));n&&e.requestId&&n.updateUIElement(t,e.requestId,this.kind)}))}RegisterIcons(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){const e={style:{MozOsxFontSmoothing:"grayscale",WebkitFontSmoothing:"antialiased",fontStyle:"normal",fontWeight:"normal",speak:"none"},fontFace:{fontFamily:'"FabricMDL2Icons"',src:`url('${t.src}') format('woff')`},icons:t.icons};Object(Se.F)(e,{disableWarnings:!0})}))}RegisterReact(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){const{extensionId:n,bundles:s}=t,i=nt(Object(x.activeContentRef)(this.store.getState()));i&&e.requestId&&i.registerReact({extensionId:n,bundles:s},e.requestId,this.kind)}))}}class _e{constructor(e){this.execHandler=e}Handshake(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){}))}Activate(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){}))}Command(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){const s=this.execHandler[t.execAction];s&&(yield s.bind(this.execHandler)(e,t,n))}))}Event(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){}))}UIToExtensionMessage(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){}))}}class ze{constructor(){this.isInitialized=!1,this.awaiters=[]}waitForInit(){return Object(i.b)(this,void 0,void 0,(function*(){if(!this.isInitialized)return new Promise(e=>{this.awaiters.push(e)})}))}start(){this.isInitialized=!0;for(const e of this.awaiters)e();this.awaiters=[]}}class Pe extends ze{constructor(e,t,n){super(),this.extensionOrder=[],this.kind=e,this.store=t,this.clientExecActionHandler=new Me(t),this.clientRequestHandler=new Ae(this.kind,t,this.clientExecActionHandler),this.clientResponseHandler=new _e(this.clientExecActionHandler),this.contextCreator=n}sendMessage(e,t,n,s){return Object(i.b)(this,void 0,void 0,(function*(){if(yield this.waitForInit(),!this.isInitialized||!this.rpcClient)throw new Error("Not initialized yet");return this.rpcClient.call(e,t,n,s)}))}respondMessage(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){if(yield this.waitForInit(),!this.isInitialized||!this.rpcClient)throw new Error("Not initialized yet");this.rpcClient.respond(e,t,n)}))}sendCommand(e,t){return Object(i.b)(this,void 0,void 0,(function*(){if(yield this.waitForInit(),!this.isInitialized||!this.rpcClient)throw new Error("Not initialized yet");this.rpcClient.send(C.ClientToServerOps.Command,{commandName:e,commandArgs:t,commandCtx:this.contextCreator.getExtensionContextPayload()})}))}receiveMessage(e){if(this.isInitialized&&this.rpcClient)if(e.header.messageType===C.MessageType.Request){const t=this.clientRequestHandler[e.header.op];t&&t.bind(this.clientRequestHandler)(e.header,e.payload,this.rpcClient)}else if(e.header.messageType===C.MessageType.Response){const t=this.clientResponseHandler[e.header.op];t&&t.bind(this.clientResponseHandler)(e.header,e.payload,this.rpcClient)}}sendEvent(e,t){return Object(i.b)(this,void 0,void 0,(function*(){if(yield this.waitForInit(),!this.isInitialized||!this.rpcClient)throw new Error("Not initialized yet");this.rpcClient.send(C.ClientToServerOps.Event,{eventName:e,eventArgs:t})}))}getExtensionOrder(){return Object(i.b)(this,void 0,void 0,(function*(){if(yield this.waitForInit(),!this.isInitialized||!this.rpcClient)throw new Error("Not initialized yet");return this.extensionOrder}))}}var qe=n("./src/common/diagnostics/index.ts");class De extends Pe{constructor(e,t,n){super(e,t,n),this.kind=e,this.store=t}getHttpMain(e,t){return e+"/api/extensions/main"}getWsMain(e,t){return e+"/api/extensions/wsmain"}initialize(e,t){return Object(i.b)(this,void 0,void 0,(function*(){if(this.hostUrl===e&&this.token===t)return;this.hostUrl&&(this.isInitialized=!1,this.rpcClient=void 0,this.httpRpcClient=void 0,this.socketRpcClient=void 0),this.hostUrl=e,this.token=t,this.httpRpcClient=new W(this.contextCreator,this.getHttpMain(this.hostUrl,this.token));const n=yield this.httpRpcClient.call(C.ClientToServerOps.Handshake,{});if(n.enablePersistentConnection){const e=function(e,t){const n=function(e,t){const n=new URL(e),s="https:"===n.protocol?"wss":"ws",i=new URLSearchParams(n.search);return i.set("schemaVersion",C.EXTENSION_PROTOCOL_VER.toString()),_()(`${s}://${n.host}/api/extensions/wsmain?${i}`)}(e),s=[];if(t===S.ExtensionHostKind.ServerAzureNotebooksService){const t=function(e){var t;if(e){const n=z.parse(e,!0);if(null===(t=null==n?void 0:n.query)||void 0===t?void 0:t.token)return n.query.token||""}return""}(e);s.push("access-token#"+t)}return new M.a(n,s,{maxReconnectionDelay:18e5,minReconnectionDelay:1e3,reconnectionDelayGrowFactor:1.5,connectionTimeout:1e4,maxRetries:1/0,debug:!1})}(this.getWsMain(this.hostUrl,this.token),S.ExtensionHostKind.ServerAzureNotebooksService);this.socketRpcClient=new Q(this.contextCreator,e,this.receiveMessage.bind(this)),this.rpcClient=this.socketRpcClient}else this.rpcClient=this.httpRpcClient;this.extensionOrder=n.extensionOrder,this.store.dispatch(d(n.extensionOrder.map(e=>({id:e,kind:this.kind})))),this.start(),yield this.rpcClient.call(C.ClientToServerOps.Activate,{activateCtx:this.contextCreator.getExtensionContextPayload()});for(const e of this.extensionOrder)qe.b.logEvent("extension loaded","extensionHost/load",{properties:{extensionId:e,extensionHostType:this.kind}})}))}}class Ke extends De{constructor(e,t,n){super(S.ExtensionHostKind.ServerAzureNotebooksService,t,n)}}class He extends De{constructor(e,t,n){super(S.ExtensionHostKind.ServerCompute,t,n)}}var Le=n("./src/iframe/common/messaging/hostMessagesForSingleIframe.ts");class Fe extends C.ClientRpcClient{constructor(e,t){super(C.CommTypes.Stateful),this.postMessage=e=>t(Le.b(e)),this.contextCreator=e}static resolveMessage(e,t){const n=Fe.outboundMessages[e];return!!n&&t.header.messageType===C.MessageType.Response&&t.header.op===n.op&&(n.resolve(t),!0)}callImpl(e,t,n,s){return Object(i.b)(this,void 0,void 0,(function*(){let i=Object(X.a)();for(;Fe.outboundMessages[i];)i=Object(X.a)();const r=this.composeMessage(e,C.MessageType.Request,t,n);return r.header.requestId=i,this.postMessage(r),new Promise((t,n)=>{Fe.outboundMessages[i]={resolve:e=>{delete Fe.outboundMessages[i],t(e)},op:e},s&&setTimeout(()=>{delete Fe.outboundMessages[i],n(new Error("Request timed out"))},s)})}))}sendImpl(e){this.postMessage(e)}overrideHeaders(e,t){return{clientVersion:this.contextCreator.getClientVersion()}}validateMessage(e){return!!S.MessageValidator.validateSchema(e)}}Fe.outboundMessages={};class Ve extends Pe{constructor(e,t,n){super(S.ExtensionHostKind.BrowserIFrame,t,n),this.config=e}initialize(e){return Object(i.b)(this,void 0,void 0,(function*(){this.postMessage=e,this.rpcClient=new Fe(this.contextCreator,e);const t=yield this.rpcClient.call(C.ClientToServerOps.Handshake,{extensionConfigs:this.config.extensions});this.extensionOrder=t.extensionOrder,this.store.dispatch(d(t.extensionOrder.map(e=>({id:e,kind:this.kind})))),this.start(),yield this.rpcClient.call(C.ClientToServerOps.Activate,{activateCtx:this.contextCreator.getExtensionContextPayload()});for(const e of this.extensionOrder)qe.b.logEvent("extension loaded","extensionHost/load",{properties:{extensionId:e,extensionHostType:this.kind}})}))}receiveMessage(e){var t;if(null===(t=null==e?void 0:e.header)||void 0===t?void 0:t.requestId){if(e.header.op in C.ServerToClientOps&&e.header.messageType===C.MessageType.Response){if(!this.isInitialized||!this.postMessage)throw new Error("Not initialized yet");this.postMessage(Le.b(e))}if(Fe.resolveMessage(e.header.requestId,e))return}super.receiveMessage(e)}}var $e=n("./src/common/request/endpoint.ts");class Ue extends ze{initialize(e){return Object(i.b)(this,void 0,void 0,(function*(){this.isInitialized?console.warn("Shouldn't see this unless hot-reloading"):(this.postMessage=e,this.start())}))}createUIElement(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){if(yield this.waitForInit(),!this.isInitialized||!this.postMessage)throw new Error("Not initialized yet");this.postMessage(Le.a(Object.assign(Object.assign({},e),{requestId:t,kind:n})))}))}updateUIElement(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){if(yield this.waitForInit(),!this.isInitialized||!this.postMessage)throw new Error("Not initialized yet");this.postMessage(Le.e(Object.assign(Object.assign({},e),{requestId:t,kind:n})))}))}postUIElementMessage(e){return Object(i.b)(this,void 0,void 0,(function*(){if(yield this.waitForInit(),!this.isInitialized||!this.postMessage)throw new Error("Not initialized yet");this.postMessage(Le.d(e))}))}registerReact(e,t,n){return Object(i.b)(this,void 0,void 0,(function*(){if(yield this.waitForInit(),!this.isInitialized||!this.postMessage)throw new Error("Not initialized yet");this.postMessage(Le.c(Object.assign(Object.assign({},e),{requestId:t,kind:n})))}))}}var Be=n("./node_modules/reselect/es/index.js");const Ge=e=>e.features[c.a],Je=Object(Be.createSelector)(Ge,e=>e.extensionOrder),Ye=Object(Be.createSelector)(Ge,Je,(e,t)=>We(t,e.codeCellCommands)),Ze=Object(Be.createSelector)(Ge,Je,(e,t)=>We(t,e.markdownCellCommands));function We(e,t){const n={};let s=0;for(const t of e)n[`${t.kind}/${t.id}`]=s++;const i=[...t];return i.sort((e,t)=>{const s=`${e.extension.kind}/${e.extension.extensionId}`,i=`${t.extension.kind}/${t.extension.extensionId}`;return n[s]-n[i]}),i}const Xe={};function Qe(e){if(!Xe[e])throw new Error("Received invalid content ref="+e);return Xe[e].iframeExtHostClient}function et(e){if(!Xe[e])throw new Error("Received invalid content ref="+e);return Xe[e].computeExtHostClient}function tt(e){if(!Xe[e])throw new Error("Received invalid content ref="+e);return Xe[e].aznbServiceExtHostClient}function nt(e){if(!Xe[e])throw new Error("Received invalid content ref="+e);return Xe[e].uiExtensionsClient}function st(e,t){if(!Xe[t])throw new Error("Received invalid content ref="+t);return e===S.ExtensionHostKind.BrowserIFrame?Xe[t].iframeExtHostClient:e===S.ExtensionHostKind.ServerAzureNotebooksService?Xe[t].aznbServiceExtHostClient:e===S.ExtensionHostKind.ServerCompute?Xe[t].computeExtHostClient:void 0}function it(e){if(!Xe[e])throw new Error("Received invalid content ref="+e);return Xe[e].contextCreator}const rt=e=>Object(i.b)(void 0,void 0,void 0,(function*(){delete Xe[e]})),ot=(e,t,n)=>Object(i.b)(void 0,void 0,void 0,(function*(){var s,i,r,o,a,l;e.epicLoader.appendEpics(L),e.reducerLoader.appendReducer(c.a,Y);const u=new G(t),d=j.d.getExtensionHostOptions(t.getState());let p,h,v;if((null===(i=null===(s=null==d?void 0:d.browser)||void 0===s?void 0:s.iframe)||void 0===i?void 0:i.enable)&&(p=new Ve(d.browser.iframe,t,u)),(null===(o=null===(r=null==d?void 0:d.server)||void 0===r?void 0:r.compute)||void 0===o?void 0:o.enable)&&(h=new He(d.server.compute,t,u)),null===(l=null===(a=null==d?void 0:d.server)||void 0===a?void 0:a.aznbService)||void 0===l?void 0:l.enable){const e=Object({NODE_ENV:"production",PUBLIC_URL:"",AZNB_PUB_COMPONENT_VERSION:"1.3.16",AZNB_PUB_DEFAULT_ENDPOINT:"%AZNB_BACKEND_ENDPOINT%",AZNB_PUB_AZNBCONTENT_ENDPOINT:"%AZNB_AZNBCONTENT_ENDPOINT%",AZNB_PUB_BUILDTAG:"notebooks-release-prod.4693184.20210426233000.c51d4ad0"}).AZNB_PUB_EXTENSION_HOST_ENDPOINT||Object($e.b)(),n=yield P(t.getState(),S.ExtensionHostKind.ServerAzureNotebooksService);if(!e||!n)throw new Error("Could not initialize Azure Notebooks service extension host client");const s=`${e}?token=${n}`;v=new Ke(d.server.aznbService,t,u),v.initialize(s)}const y=new Ue;Xe[n]={iframeExtHostClient:p,computeExtHostClient:h,aznbServiceExtHostClient:v,uiExtensionsClient:y,contextCreator:u}}))}}]);